<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="../css/site.css" rel="stylesheet" />
    <link href="../lib/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
    <link href="../lib/handsontable/dist/handsontable.css" rel="stylesheet" />
</head>
<body>
    <div class="bg"></div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">OdataFluentUI</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item active">
                        <a class="nav-link" aria-current="page" href="#">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-table" viewBox="0 0 16 16">
                                <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z" />
                            </svg>
                            Handsontable
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-xml" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M14 4.5V14a2 2 0 0 1-2 2v-1a1 1 0 0 0 1-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5ZM3.527 11.85h-.893l-.823 1.439h-.036L.943 11.85H.012l1.227 1.983L0 15.85h.861l.853-1.415h.035l.85 1.415h.908l-1.254-1.992 1.274-2.007Zm.954 3.999v-2.66h.038l.952 2.159h.516l.946-2.16h.038v2.661h.715V11.85h-.8l-1.14 2.596h-.025L4.58 11.85h-.806v3.999h.706Zm4.71-.674h1.696v.674H8.4V11.85h.791v3.325Z" />
                            </svg>
                            Odata(XML)
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-filetype-json" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M14 4.5V11h-1V4.5h-2A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v9H2V2a2 2 0 0 1 2-2h5.5L14 4.5ZM4.151 15.29a1.176 1.176 0 0 1-.111-.449h.764a.578.578 0 0 0 .255.384c.07.049.154.087.25.114.095.028.201.041.319.041.164 0 .301-.023.413-.07a.559.559 0 0 0 .255-.193.507.507 0 0 0 .084-.29.387.387 0 0 0-.152-.326c-.101-.08-.256-.144-.463-.193l-.618-.143a1.72 1.72 0 0 1-.539-.214 1.001 1.001 0 0 1-.352-.367 1.068 1.068 0 0 1-.123-.524c0-.244.064-.457.19-.639.128-.181.304-.322.528-.422.225-.1.484-.149.777-.149.304 0 .564.05.779.152.217.102.384.239.5.41.12.17.186.359.2.566h-.75a.56.56 0 0 0-.12-.258.624.624 0 0 0-.246-.181.923.923 0 0 0-.37-.068c-.216 0-.387.05-.512.152a.472.472 0 0 0-.185.384c0 .121.048.22.144.3a.97.97 0 0 0 .404.175l.621.143c.217.05.406.12.566.211a1 1 0 0 1 .375.358c.09.148.135.335.135.56 0 .247-.063.466-.188.656a1.216 1.216 0 0 1-.539.439c-.234.105-.52.158-.858.158-.254 0-.476-.03-.665-.09a1.404 1.404 0 0 1-.478-.252 1.13 1.13 0 0 1-.29-.375Zm-3.104-.033a1.32 1.32 0 0 1-.082-.466h.764a.576.576 0 0 0 .074.27.499.499 0 0 0 .454.246c.19 0 .33-.055.422-.164.091-.11.137-.265.137-.466v-2.745h.791v2.725c0 .44-.119.774-.357 1.005-.237.23-.565.345-.985.345a1.59 1.59 0 0 1-.568-.094 1.145 1.145 0 0 1-.407-.266 1.14 1.14 0 0 1-.243-.39Zm9.091-1.585v.522c0 .256-.039.47-.117.641a.862.862 0 0 1-.322.387.877.877 0 0 1-.47.126.883.883 0 0 1-.47-.126.87.87 0 0 1-.32-.387 1.55 1.55 0 0 1-.117-.641v-.522c0-.258.039-.471.117-.641a.87.87 0 0 1 .32-.387.868.868 0 0 1 .47-.129c.177 0 .333.043.47.129a.862.862 0 0 1 .322.387c.078.17.117.383.117.641Zm.803.519v-.513c0-.377-.069-.701-.205-.973a1.46 1.46 0 0 0-.59-.63c-.253-.146-.559-.22-.916-.22-.356 0-.662.074-.92.22a1.441 1.441 0 0 0-.589.628c-.137.271-.205.596-.205.975v.513c0 .375.068.699.205.973.137.271.333.48.589.626.258.145.564.217.92.217.357 0 .663-.072.917-.217.256-.146.452-.355.589-.626.136-.274.205-.598.205-.973Zm1.29-.935v2.675h-.746v-3.999h.662l1.752 2.66h.032v-2.66h.75v4h-.656l-1.761-2.676h-.032Z" />
                            </svg>
                            OpenApi(JSON)
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <ul class="nav nav-tabs" style="margin-top:6px">
            <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">Metadata</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Mapper</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Config</a>
            </li>
        </ul>
        <div>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <strong>Holy guacamole!</strong> You should check in on some of those fields below.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div class="input-group" style="margin-top:6px;margin-bottom:6px">
                <span class="input-group-text" id="basic-addon1">Uri</span>
                <input id="odataUri" type="text" class="form-control" value="http://localhost:5201/odata/$metadata" placeholder="http://localhost:5201/odata/$metadata">
                <button class="btn btn-primary" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                    </svg>
                </button>
                <button class="btn btn-success" type="button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightning-charge" viewBox="0 0 16 16">
                        <path d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09zM4.157 8.5H7a.5.5 0 0 1 .478.647L6.11 13.59l5.732-6.09H9a.5.5 0 0 1-.478-.647L9.89 2.41 4.157 8.5z" />
                    </svg>
                </button>
            </div>
            <div>
                <textarea id="metadata" class="bg-light body-container"></textarea>
            </div>
        </div>

    </div>

    <script src="../lib/jquery/dist/jquery.js"></script>
    <script src="../lib/bootstrap/dist/js/bootstrap.js"></script>

    <link href="../lib/codemirror/lib/codemirror.css" rel="stylesheet" />
    <script src="../lib/codemirror/lib/codemirror.js"></script>

    <link href="../lib/codemirror/theme/cobalt.css" rel="stylesheet" />

    <link href="../lib/codemirror/addon/fold/foldgutter.css" rel="stylesheet" />
    <script src="../lib/codemirror/addon/fold/foldgutter.js"></script>

    <script src="../lib/codemirror/addon/selection/active-line.js"></script>
    <script src="../lib/codemirror/addon/fold/foldcode.js"></script>
    <script src="../lib/codemirror/addon/fold/brace-fold.js"></script>

    <script src="../lib/codemirror/mode/javascript/javascript.js"></script>
    <script src="../lib/codemirror/mode/xml/xml.js"></script>
    <!--<script src="../lib/codemirror/mode/htmlmixed/htmlmixed.js"></script>-->

    <script src="../lib/codemirror/addon/search/search.js"></script>
    <script src="../lib/codemirror/addon/search/searchcursor.js"></script>
    <script src="../lib/codemirror/addon/search/jump-to-line.js"></script>

    <link href="../lib/codemirror/addon/dialog/dialog.css" rel="stylesheet" />
    <script src="../lib/codemirror/addon/dialog/dialog.js"></script>

    <link href="../lib/codemirror/addon/display/fullscreen.css" rel="stylesheet" />
    <script src="../lib/codemirror/addon/display/fullscreen.js"></script>
    <script type="text/javascript">

        $(function () {
            QueryOdataMetadata();
        });

        var metadata;
        function QueryOdataMetadata() {
            var uri = $("#odataUri").val();
            $.get(uri, function (data, status, xhr) {
                metadata = data;
                var editor = document.getElementById("metadata");
                myCodeMirror = CodeMirror.fromTextArea(editor, {
                    mode: 'text/html',
                    //theme: 'cobalt',
                    styleActiveLine: true,
                    lineNumbers: true,
                    lineWrapping: true,
                    foldGutter: true,
                    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter", "CodeMirror-lint-markers"],
                    readOnly: false
                });
                myCodeMirror.setSize("auto", 440);
                myCodeMirror.setValue(document.documentElement.innerHTML);
                //myCodeMirror.setValue((new XMLSerializer()).serializeToString(metadata.documentElement));
            });
        }

        function MapperOdataMetadata(odataXml, printLog = false) {
            var odataXmlDocuments = $.parseXML(odataXml);
            var entityTypes = $(odataXmlDocuments).find('EntityType');
            var handsonTableAccessories = [];
            var odata = { entityTypes: [], enumTypes: [] };
            $(entityTypes).each(function (entityTypeIndex, entityType) {
                var accessories = {}, entityT = { propertys: [] };
                var entityName = entityType.attributes.Name.value;
                accessories.entityName = entityName;
                entityT.name = entityName;
                var Propertys = $(entityType).find('Property');
                var colHeaders = [], columns = [];
                $(Propertys).each(function (propertyIndex, Property) {
                    var key = $($(entityType).find('Key')).first();
                    var propertyRefs = $(key).find('PropertyRef');
                    var keyRefs = [];
                    $(propertyRefs).each(function (refIndex, propertyRef) {
                        var keyName = propertyRef.attributes.Name.value;
                        keyRefs.push(keyName);
                    });
                    entityT.keys = keyRefs;
                    var column = {}, property = {};
                    var propertyAttributeName = Property.attributes.Name.value;
                    colHeaders.push(propertyAttributeName);
                    column.data = propertyAttributeName;
                    property.name = propertyAttributeName;
                    var propertyAttributeType = Property.attributes.Type.value;
                    property.dataType = propertyAttributeType;
                    if (Property.attributes.hasOwnProperty('Nullable')) {
                        var propertyAttributeNullable = Property.attributes.Nullable.value;
                        property.required = propertyAttributeNullable === "false" ? true : false;
                    }
                    else {
                        property.required = false;
                    }
                    if (Property.attributes.hasOwnProperty('DefaultValue')) {
                        var propertyAttributeDefaultValue = Property.attributes.DefaultValue.value;
                        property.defaultValue = propertyAttributeDefaultValue;
                    }
                    if (Property.attributes.hasOwnProperty('MaxLength')) {
                        var propertyAttributeMaxLength = Property.attributes.MaxLength.value;
                        property.maxLength = propertyAttributeMaxLength;
                    }
                    // https://docs.oasis-open.org/odata/odata-csdl-xml/v4.01/os/odata-csdl-xml-v4.01-os.html#sec_PrimitiveTypes
                    if (['Edm.Decimal', 'Edm.Double', 'Edm.Int16', 'Edm.Int32', 'Edm.Int64', 'Edm.Single',].includes(propertyAttributeType)) {
                        column.type = 'numeric';
                    }
                    else if (['Edm.Date', 'Edm.DateTimeOffset'].includes(propertyAttributeType)) {
                        column.type = 'date';
                        column.dateFormat = 'YYYY-MM-DD';
                    }
                    else if (propertyAttributeType === 'Edm.Boolean') {
                        column.type = 'checkbox';
                    }
                    else if (propertyAttributeType.endsWith('EnumType')) {
                        column.type = 'dropdown';
                        var enumTypeName = propertyAttributeType.split('.')[1];
                        let enumTypes = $(odataXmlDocuments).find('EnumType');
                        $(enumTypes).each(function (enumTypeIndex, enumType) {
                            if (enumType.attributes.Name.value === enumTypeName) {
                                column.source = [];
                                property.enums = [];
                                var members = $(enumType).find('Member');
                                $(members).each(function (memberIndex, member) {
                                    var memberName = member.attributes.Name.value;
                                    var memberValue = member.attributes.Value.value;
                                    column.source.push(memberName);

                                    property.enums.push({ name: memberName, value: memberValue });
                                });
                            }
                        });
                    }
                    else {
                        column.type = 'text';
                    }
                    columns.push(column);

                    entityT.propertys.push(property);
                });
                accessories.colHeaders = colHeaders;
                accessories.columns = columns;
                handsonTableAccessories.push(accessories);

                odata.entityTypes.push(entityT);
            });

            var enumTypes = $(odataXmlDocuments).find('EnumType');
            $(enumTypes).each(function (enumTypeIndex, enumType) {
                var enumT = { enums: [] };
                var enumName = enumType.attributes.Name.value;
                enumT.name = enumName;
                var members = $(enumType).find('Member');
                $(members).each(function (memberIndex, member) {
                    var memberName = member.attributes.Name.value;
                    var memberValue = member.attributes.Value.value;
                    enumT.enums.push({ name: memberName, value: memberValue });
                });
                odata.enumTypes.push(enumT);
            });

            if (printLog) {
                console.log(JSON.stringify(handsonTableAccessories));
                console.log(JSON.stringify(odata));
            };
            return { handsonTableAccessories: handsonTableAccessories, odata: odata };
        };

        function GenerateEditorConfig(odata, printLog = false) {
            var configs = JSON.parse(JSON.stringify(odata.entityTypes));
            $(configs).each(function (configIndex, config) {
                $(config.propertys).each(function (propertyIndex, property) {
                    property.editor = 'input';
                    if (['Edm.Decimal', 'Edm.Double', 'Edm.Int16', 'Edm.Int32', 'Edm.Int64', 'Edm.Single',].includes(property.dataType)) {
                        property.editorType = 'number';
                    }
                    else if (['Edm.Date', 'Edm.DateTimeOffset'].includes(property.dataType)) {
                        property.editorType = 'date';
                    }
                    else if (property.dataType === 'Edm.Boolean') {
                        property.editorType = 'number';
                    }
                    else if (property.dataType.endsWith('EnumType')) {
                        property.editor = 'select';
                    }
                    else {
                        property.editorType = 'text';
                    }
                    if (config.keys.includes(property.name)) {
                        property.readonly = true;
                    }
                    else {
                        property.readonly = false;
                    }
                });
            });
            return configs;
        }
    </script>
</body>
</html>